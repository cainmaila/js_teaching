
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Flash玩膩轉換心情寫Canvas</title>
	<style>
		body {
			margin: 0px;
			padding: 0px;
			background-color: #000000;
			width: 100%;
			height: 100%;
			overflow: hidden;
		}
	</style>
	<script src="http://code.jquery.com/jquery-1.11.1.js"></script>
	<script src="pixi.1.1.js"></script>
	<script src="CainPixi.js"></script>
</head>
<body>
	<script>
	var bunny;
	var npc2,npc;
	var arr = [];
	var w,h;
	// create an new instance of a pixi stage
	var stage = new PIXI.Stage(0x66FF99);
	// create a renderer instance
	var renderer = new PIXI.WebGLRenderer(800, 600);//autoDetectRenderer(400, 300);
	
	function resize(){
		w = $(window).width();
		h = $(window).height();
		renderer.resize(w, h);
	};
	resize();
	// add the renderer view element to the DOM
	document.body.appendChild(renderer.view);
	var assetsToLoader = ["npc.png","npc2.png","npc3.png","talk.png"];
	loader = new PIXI.AssetLoader(assetsToLoader);
	loader.onComplete = onAssetsLoaded;
	loader.load();
	function onAssetsLoaded(){
		bunny = CainPixi.Npc("npc.png","talk.png",25,3);
		bunny.position.x = 400;
		bunny.position.y = 300;
		stage.addChild(bunny);
		
		var t2;
		arr.push(bunny);
		
		for(var i=0;i<200;i++){
			npc2 = CainPixi.Npc("npc3.png");
			npc2.position.x = Math.random()*w;
			npc2.position.y = Math.random()*h;
			stage.addChild(npc2);
			arr.push(npc2);
		}
		
		npc = CainPixi.Npc("npc2.png","talk.png",30,3);
		npc.position.x = 500;
		npc.position.y = 500;
		stage.addChild(npc);
		arr.push(npc);
		bunny.autoMove(2,{x:100,y:500},function(){bunny.talk("OK!")});
		requestAnimFrame( animate );
		
		stage.setInteractive(true);
		var r = 1;
		stage.mouseup = stage.touchend = function(data){
			if(off>0) return;
			off = 10;
			if(r==1){
				bunny.autoMove(2,{x:data.global.x,y:data.global.y});
				bunny.talk("移動到"+data.global.x+","+data.global.x);
			}else{
				npc.autoMove(2,{x:data.global.x,y:data.global.y});
				npc.talk("移動到"+data.global.x+","+data.global.x);
			}
			r*=-1;
		}
	};	
	var off = 0;
	// create a texture from an image path
	// create a new Sprite using the texture
	//texture.setFrame(new PIXI.Rectangle(0,0,50,50));
	function animate() {
		off--;
	   	requestAnimFrame( animate );
		arr.sort(function(a,b){
			if(a.position.y<b.position.y){
				return -1;
			}else{
				return 1;
			}
		});
		var _num = arr.length;
		var _i = 0;
		for(_i;_i<_num;_i++){
			stage.addChild(arr[_i]);
			arr[_i].nextFrame();
		}
		renderer.render(stage);
	}
	$(window).resize(resize);
	window.onorientationchange = resize;
	$(window).keydown(function(e){
			//console.log(e.keyCode);
			e.stopPropagation();   
			switch (e.keyCode){
				case 38:
					//console.log("上");
					bunny.move(2,5);
				break;
				case 40:
					//console.log("下");
					bunny.move(0,5);
				break;
				case 37:
					//console.log("左");
					bunny.move(1,5);
				break;
				case 39:
					//console.log("右");
					bunny.move(3,5);
				break;
				case 13:
					//console.log("enter");
					bunny.talk("OK!");
				break;
				default:	
			}
		});
	</script>
	</body>
</html>
