<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>抽獎機範例</title>
    <!-- <link rel="stylesheet" type="text/css" href="./css/normalize.min.css"> -->
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <style type="text/css">
    #ui button {
        width: 200px;
        height: 50px;
        font-size: 24px;
    }
    
    #message {
        display: none;
    }
    </style>
</head>

<body>
    <div class="container">
        <h1>抽獎機範例</h1>
        <hr>
        <div id="ui">
            <button id="lotteryBn">抽獎</button>
            <div id="message" class="alert alert-danger">抽獎結束!</div>
        </div>
        <div id="result">
            <table class="table table-striped">
                <tbody>
                </tbody>
            </table>
        </div>
        <hr>
        <h3>抽獎人名單</h3>
        <div id="users">
        </div>
        <hr>
        <h3>獎品</h3>
        <div id="prizes">
        </div>
    </div>
    <script src="./js/jquery-3.1.1.min.js"></script>
    <script>
    var $users = $('#users');
    var $prizes = $('#prizes');
    var $result_table = $('#result > table > tbody');
    var $lotteryBn = $('#lotteryBn');
    var $showName = $('#showName');
    var userList; //抽獎人名單
    var prizeList; //獎品資訊
    var isRadom = false; //正在抽獎中
    var timeId; //timer id
    //更新抽獎人資訊
    $.get('./user.txt').then(loadUsersData, errorMessage);
    $.get('./prize.json').then(loadPrizeData, errorMessage);

    $lotteryBn.on('click', function() {
        var radomId, prize, winner, data, len;

        if (isRadom) {
            //抽出一名
            isRadom = false;
            clearInterval(timeId);
            prize = prizeList.shift();
            winner = userList.splice(radomId, 1);
            data = {
                name: winner[0],
                prize: prize
            }
            pushAnWinner(data, $result_table);
            buildUsersDom(userList, $users);
            buildPrizesDom(prizeList, $prizes);
            if (prizeList.length === 0 || userList.length === 0) {
                $('#message').css('display', 'block');
                $lotteryBn.css('display', 'none');
                return;
            }
        } else {
            //抽出一名
            isRadom = true;
            len = userList.length;
            radomId = Math.random() * len;
            radomId = Math.floor(radomId);
            timeId = setInterval(function() {
                $lotteryBn.html(userList[radomId]);
                radomId++;
                radomId = radomId >= len ? 0 : radomId;
            }, 50);
        }
    });

    //建立一筆得獎資料
    function pushAnWinner(data, $div) {
        var $dom = $('<tr></tr>');
        $dom.append('<td>' + data.name + '</td>');
        $dom.append('<td>' + data.prize.name + '</td>');
        $dom.append('<td>' + data.prize.food + '</td>');
        $div.append($dom);
    }

    //取得抽獎人資料後
    function loadUsersData(userData) {
        userList = userData.split(',');
        //整理陣列
        userList = userList.map(function(name) {
            return name.trim(); //清除前後空格
        });
        //建立名單DOM
        buildUsersDom(userList, $users);
    }

    function loadPrizeData(prizeData) {
        prizeList = JSON.parse(prizeData);
        buildPrizesDom(prizeList, $prizes);
    }

    function buildPrizesDom(prizeList, $div) {
        var $tr;
        $div.html('');
        $div.append('<table class="table table-striped"><tbody></tbody></table>');
        $div = $div.find('table > tbody');
        prizeList.map(function(prize) {
            $tr = $('<tr></tr>');
            $tr.append('<td>' + prize.name + '</td>');
            $tr.append('<td>' + prize.food + '</td>');
            $div.append($tr);
        });
    }

    //建立名單DOM
    function buildUsersDom(userList, $div) {
        var userDom;
        $div.html('');
        $div.append('<ul class="list-group"></ul>');
        $div = $div.find('ul'); //尋找ul標籤
        userList.map(function(userName) {
            userDom = '<li class="list-group-item">' + userName + '</li>';
            $div.append(userDom);
        });
    }

    //印出錯誤資訊
    function errorMessage(error) {
        console.log(error.statusText);
        alert(error.statusText);
    }
    </script>
    <script src="http://127.0.0.1:35729/livereload.js"></script>
</body>

</html>
