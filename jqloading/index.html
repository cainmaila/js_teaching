<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Jq範例 - 偽造Loading進度</title>
    <link rel="stylesheet" type="text/css" href="./css/normalize.min.css">
    <style>
    body {
        overflow: hidden;
    }
    
    #loadingBk {
        position: fixed;
        left: 0px;
        right: 0px;
        top: 0px;
        bottom: 0px;
        background-color: #ffa;
    }
    
    #paTxt {
        position: absolute;
        left: 50%;
        top: 50%;
        font-size: 24px;
        transform: translate(-64px, -50%);
    }
    
    #loadbar {
        position: absolute;
        top: 0px;
        left: 0px;
        width: 0%;
        height: 10px;
        background-color: #f00;
    }
    
    #svgArc {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }
    
    .imageLoading {
        background: url('./images/Loading_icon.gif');
        background-position: center center;
        background-repeat: no-repeat;
        width: 100%;
        min-height: 500px;
    }
    </style>
</head>

<body>
    <div id="loadingBk">
        <div id="paTxt">loading 0%</div>
        <div id="loadbar">
        </div>
        <div id="svgArc">
        </div>
    </div>
    <h1>Jq範例 - Loading</h1>
    <img class="imageLoading" id="bigpcx">
    <script src="../lib/jquery-3.1.1.min.js"></script>
    <script src="./js/drawSvgArc.js"></script>
    <script>
    var $loadingBk = $('#loadingBk'); //載入loading畫面
    var $loadPa = $('#paTxt'); //載入loading文字
    var $loadbar = $('#loadbar');
    var pa = 0; //loading進度 0~100
    var step = 0; //載入情況的狀態機 0載入中 1載入完成 2進度條100可以進場
    var loadingTimer; //計時器
    var svg = new DrawSvgArc('#svgArc', 100, '#f00'); //新增svg百分比圓形繪製物件
    loadingTimer = setInterval(nowLoading, 100); //定義計時器，每100毫秒執行一次nowLoading()
    $(document).ready(onReady); //載完就觸發onReady()
    // $(onReady); //與上行一樣意思
    var pcx = new Image();
    pcx.src = './images/bigpcx.jpg';
    pcx.onload = function() {
        console.log('圖片載入完成2');
        $('#bigpcx').attr('src', pcx.src);
    }

    //計時器執行
    function nowLoading() {
        if (step === 0) { //載入中,pa持續加+
            pa++; //pa + 1
            if (pa === 100) { //因為還沒載完，我們不能讓他等於100
                pa === 99;
            }
            // pa = pa === 100 ? 99 : pa;
            $loadPa.html('loading ' + pa + '%'); //進度填入畫面
            $loadbar.css('width', pa + '%'); //設定上方進度
            svg.setAg(pa / 100 * 360); //設定畫圓角度
        } else if (step === 1) { //網頁載入完成
            pa += 10; //加速載入
            if (pa >= 100) { //進度條到達100時
                pa = 100; //有可能超過100比方102，但是我們希望最大不要超過100
                step = 2; //改變狀態機
            }
            $loadPa.html('loading ' + pa + '%');
            $loadbar.css('width', pa + '%');
            svg.setAg(pa / 100 * 360);
        } else if (step === 2) { //進度條到達100，進場畫面
            clearInterval(loadingTimer);
            $loadingBk.fadeOut(1000);
            $('body').css('overflow', 'auto'); //預設卷軸關閉，進場後就可以打開
        }
    }

    //觸發載入完成事件
    function onReady() {
        console.log('頁面載入完成');
        step = 1;
    }
    </script>
</body>

</html>
